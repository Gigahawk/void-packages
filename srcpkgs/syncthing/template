# Template file for 'syncthing'
pkgname=syncthing
version=1.1.0
revision=2
build_style=go
wrksrc=syncthing
go_import_path="github.com/syncthing/syncthing"
go_package="${go_import_path}/cmd/strelaysrv ${go_import_path}/cmd/syncthing"
go_build_tags="noupgrade"
go_ldflags="-X main.Version=v${version}"
hostmakedepends="git"
short_desc="Open Source Continuous File Synchronization"
maintainer="Duncaen <duncaen@voidlinux.org>"
license="MPL-2.0"
#changelog="https://github.com/syncthing/syncthing/releases"
homepage="http://syncthing.net/"
distfiles="https://github.com/syncthing/${pkgname}/releases/download/v${version}/syncthing-source-v${version}.tar.gz"
checksum=6565fd30d704f7039d350c522875925acc287c8e45e18a7d42f22512860a7ac6

pre_build() {
	GOARCH= go run script/genassets.go gui > ./lib/auto/gui.files.go
}

do_build() {
	go_package=${go_package:-$go_import_path}
	go_mod_mode=vendor
	go run -mod="${go_mod_mode}" -x -tags "${go_build_tags}" -ldflags "${go_ldflags}" build.go
}

do_install() {
	vbin bin/syncthing
}

post_install() {
	vlicense LICENSE
	vdoc README.md
}

syncthing-relaysrv_package() {
	short_desc+=" - relay server"
	license="MIT"
	replaces="relaysrv>=0.12.18_2"
	provides="relaysrv-${version}_${revision}"
	system_accounts="relaysrv"
	relaysrv_homedir="/var/lib/relaysrv"

	make_dirs="
	 /var/log/relaysrv 700 root root
	 /var/lib/relaysrv 700 relaysrv relaysrv"

	pkg_install() {
		vbin bin/strelaysrv
		vlicense cmd/strelaysrv/LICENSE
		vsv relaysrv
	}
}
